# rd.collab.snn

本プログラム群で以下のことを行えます．
1. STDPのパラメータに対し臨界性の指標がどのように変動するか解析する（auto_exp_multi.sh）
1. SNNの発達時に各種指標がどのように変動するか解析する（auto_exp_single.sh）
1. 外部刺激へのSNNの情報表現能力を刺激識別率として定量化し，発達の各時刻で比較する（auto_SIE_development.sh，auto_quantification_development_xN.sh）
1. SNNに反復刺激を加えて刺激パターンの学習を促し，その前後における情報表現能力を比較する（auto_SIE.sh，auto_quantification_xN.sh）

上記シェルスクリプト内で，複数のpythonスクリプトもしくはシェルスクリプトが順番に実行され，生データおよび解析結果がpdfとして出力されます．
これらスクリプトを実行する前に，下記のライブラリをインストールしてください．
また，utils_c.pyxをビルドするために，lib内でbuild.shを実行してください（bash build.sh）．
- brian2
- quantities
- neo
- elephant

以下では，各実験を行うための上記シェルスクリプトについて説明します．

## auto_exp_multi.sh
使い方： bash auto_exp_multi.sh \[実験条件設定ファイル\] \[出力ディレクトリ\] \[シミュレーション時間L(hour)\]

本シェルスクリプトは，実験条件設定ファイルで指定されたパラメータごとにSNNを一つ作成し，シミュレーション時間分SNNを自発活動させます．
実験条件設定ファイルのサンプルは共有ドライブにあります（先頭にexp_settingと名付けられたjsonファイル）．
実験条件設定ファイルでは，複数のBEとBI（STDPのパラメータのベータEとベータI）を指定できます．
実験条件設定ファイルで指定されたパラメータを持つSNNの設定ファイル（先頭にconfigと名付けられたjsonファイル）が作成されます．
例えば，BEに5個の値，BIに10個の値を指定した場合，5×10で合計50個のSNNが作成されます．
なお，実験条件設定ファイルで指定されていないパラメータの値は，default_config.jsonで指定された値となります．
各SNNは対応するconfigファイルで初期化され，自発活動で徐々に変化します．
SNNの結合強度や膜電位，コンダクタンスなどのSNNの状態は，一時間おきにnpz形式で保存され（先頭にstatesと名付けられたファイル）ます．
また，１時間おきに自発活動が10分間計測され，先頭にrecordと名付けられたnpzファイルに保存されます．

シミュレーションがL時間分回ったら，SNNごとに初期化直後からL時間まででSNNの各種指標を算出し，その時間変化を先頭にindices，synapseと名付けられたファイルにそれぞれ出力します．
また，L時間目の各条件のSNNで臨界性の指標を算出し，先頭にdeltaと名付けられたpdfファイルに出力します．
実験条件設定ファイルに複数のBE，BIが指定されている場合，縦にBE，横にBIとなるようにマップ状に臨界性の指標がプロットされます．

なお，作成された各SNNのシミュレーションが複数プロセスで同時に走ります．
そのため，それらプロセスを走らせるだけの十分なプロセス数を実行できる環境で実行してください．
以下のスクリプトについても同様です．

## auto_exp_single.sh
使い方： bash auto_exp_single.sh \[configファイル\] \[出力ディレクトリ\] \[SNNの数N\] \[シミュレーション時間L(hour)\] (解析のみ行う場合は第五引数を指定)

本シェルスクリプトは，configファイルで指定されたパラメータを持つSNNをN個作成し，それぞれ異なる乱数シードでシミュレーション時間分自発活動させます．
実験条件設定ファイルはauto_exp_multi.shで作成されますが，make_config.pyにてパラメータの値を引数に指定することでも作成されます．
本シェルスクリプトで作成されるファイルはauto_exp_multi.shと同様です．
先頭にdevelopmentと名付けられたpdfファイルには，SNNの各種指標，および結合強度の平均値の時間変化が図として出力されます．

## auto_SIE_development.sh
使い方： bash auto_SIE_development.sh \[configファイル\] \[出力ディレクトリ\] \[padding\] \[SNNの数N\] \[シミュレーション時間L(hour)\] \[刺激パターン(txt)\]

刺激パターンで指定された空間パターン刺激を，auto_exp_single.shで作成されたN個のSNNに加え，その誘発応答を記録します．
auto_exp_single.shを実行してL時間目のSNNを作成してから本スクリプトを実行してください．
また，configファイルには，auto_exp_single.shの出力ディレクトリ内のconfigファイルを指定してください．

N個のSNNそれぞれに対応したディレクトリが，出力ディレクトリに作成されます．
初期化直後からL時間目までの各SNNに，刺激パターンを加え，その誘発応答をnpzファイルに記録します．
誘発応答の記録されたファイルの名前は，\[パターン番号\]\_\[トライアル\]\_\[初期化直後からの時間\].npzです．
なお，paddingで指定された時間分だけ，刺激実験で用いられるSNNの間隔が空けられます．
例えばpaddingが12であれば，初期化直後，12時間後，24時間後，・・・，といったように12時間おきのSNNで実験が行われます．

刺激パターン（patterns.txt）は共有ドライブに上がっています．
刺激パターンの各行は刺激パターンであり，刺激されるニューロンのIDがスペース区切りで指定されています．

## auto_quantification_development_xN.sh
使い方： bash auto_quantification_development_xN.sh \[解析元ディレクトリ\] \[SNNの数N\] \[シミュレーション時間L(hour)\] \[ビン幅W\] \[padding\]

auto_SIE_development.shで得られた誘発応答をビン幅Wのウィンドウで発火率ベクトルに変換し，その発火率ベクトルを用いてSLRで刺激のクラス分類を行い，その識別率を算出します．
誘発応答中に刺激の情報が表現されていれば，識別率は高くなるはずです．
従って，得られた識別率はSNNの情報表現能力を定量化しています．

解析元ディレクトリにはauto_SIE_development.shで出力ディレクトリに指定したディレクトリを指定してください．
NとL，およびpaddingには，auto_SIE_development.shで指定した値をそれぞれ指定してください．

fig_ifrで始まるファイルには，各時刻における誘発応答の発火率と自発活動の発火率（ベースライン），ベースラインに対する誘発応答のZスコアが出力されます．
fig_slrで始まるファイルには，各時刻におけるSLRの識別率，最も有意な差のあったビンにおける識別率のボックスプロットが出力されます．

## auto_SIE.sh
使い方： bash auto_SIE.sh \[configファイル\] \[出力ディレクトリ\] \[初期化からの時間T\] \[シミュレーション時間L(hour)\] \[刺激パターン(txt)\] \[刺激回数S\] \[padding\] (解析のみ行う場合は第八引数を指定)

auto_exp_single.shで作成されたSNNに，刺激パターンで指定された空間パターン刺激を刺激回数Sだけ1Hzで反復して入力します．
その後，シミュレーション時間LだけSNNを自発活動させ，auto_SIE_development.shと同様にpadding間隔で反復刺激前後のSNNに刺激パターンを加えて誘発応答を記録します．
auto_exp_single.shを実行してL時間目のSNNを作成してから本スクリプトを実行してください．
なお，T時間だけ自発活動したSNNが用いられるため，auto_exp_single.shでT時間目まで自発活動したSNNを作成してください．
また，configファイルには，auto_exp_single.shの出力ディレクトリ内のconfigファイルを指定してください．

N個のSNNそれぞれに対応したディレクトリが，出力ディレクトリに作成されます．
初期化直後からL時間目までの各SNNに，刺激パターンを加え，その誘発応答をnpzファイルに記録します．
誘発応答の記録されたファイルの名前は，\[パターン番号\]\_\[トライアル\]\_\[初期化直後からの時間\].npzです．
なお，paddingで指定された時間分だけ，刺激実験で用いられるSNNの間隔が空けられます．
例えばpaddingが12であれば，初期化直後，12時間後，24時間後，・・・，といったように12時間おきのSNNで実験が行われます．

先頭にfig_developmentと名付けられたpdfファイルには，SNNの各種指標，および結合強度の平均値の時間変化が図として出力されます．

刺激パターン（patterns.txt）は共有ドライブに上がっています．
刺激パターンの各行は刺激パターンであり，刺激されるニューロンのIDがスペース区切りで指定されています．

## auto_quantification_xN.sh
使い方： bash auto_quantification_xN.sh \[解析元ディレクトリ\] \[SNNの数N\] \[シミュレーション時間L(hour)\] \[ビン幅W\] \[padding\] (第六引数が指定された場合，それを接尾辞として出力ファイルに付与する)

auto_SIE.shで得られた誘発応答をビン幅Wのウィンドウで発火率ベクトルに変換し，その発火率ベクトルを用いてSLRで刺激のクラス分類を行い，その識別率を算出します．

解析元ディレクトリにはauto_SIE_development.shで出力ディレクトリに指定したディレクトリを指定してください．
NとL，およびpaddingには，auto_SIE_development.shで指定した値をそれぞれ指定してください．

fig_ifrで始まるファイルには，各時刻における誘発応答の発火率と自発活動の発火率（ベースライン），ベースラインに対する誘発応答のZスコアが出力されます．
fig_slrで始まるファイルには，各時刻におけるSLRの識別率，最も有意な差のあったビンにおける識別率のボックスプロットが出力されます．

